---
# yaml-language-server: $schema=https://schemas.bykaj.io/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: authentik
spec:
  chartRef:
    kind: OCIRepository
    name: authentik
  interval: 1h
  values:
    # Global configuration
    global:
      priorityClassName: system-cluster-critical
      podAnnotations:
        reloader.stakater.com/auto: "true"
      deploymentStrategy:
        type: Recreate
      env:
        - name: AUTHENTIK_REDIS__DB
          value: "1"
        - name: AUTHENTIK_STORAGE__MEDIA__BACKEND
          value: "s3"
        - name: AUTHENTIK_STORAGE__MEDIA__S3__SECURE_URLS
          value: "true"
        - name: TZ
          value: "${TIMEZONE}"
      envFrom:
        - secretRef:
            name: &secret authentik-secret
      volumeMounts:
        - name: custom-templates
          mountPath: /templates
      volumes:
        - name: custom-templates
          configMap:
            name: authentik-custom-templates

    # Authentik configuration
    authentik:
      disable_startup_analytics: true
      disable_update_check: false
      email:
        port: 587
        timeout: 30
        use_tls: true
      error_reporting:
        enabled: false
      events:
        context_processors:
          geoip: "/geoip/GeoLite2-City.mmdb"
          asn: "/geoip/GeoLite2-ASN.mmdb"
      log_level: "info"
      postgresql:
        host: "${DB_HOST}"
      redis:
        host: "${REDIS_HOST}"

    # GeoIP Updater
    geoip:
      enabled: false
      editionIds: "GeoLite2-City GeoLite2-ASN"
      existingSecret:
        secretName: *secret
        accountId: "GEOIPUPDATE_ACCOUNT_ID"
        licenseKey: "GEOIPUPDATE_LICENSE_KEY"
      updateInterval: 24
      resources:
        requests:
          cpu: 5m
          memory: 128Mi
        limits:
          memory: 256Mi

    # Authentik Server
    server:
      initContainers:
        - name: init-db
          image: ghcr.io/home-operations/postgres-init:17.6.0@sha256:86a1992d46273c58fd4ad95b626081dfaabfe16bd56944675169e406d1a660dd
          envFrom:
            - secretRef:
                name: *secret
      replicas: 1
      metrics:
        prometheus:
          serviceMonitor:
            enabled: true
      resources:
        requests:
          cpu: 100m
          memory: 512Mi
        limits:
          memory: 2Gi
      volumeMounts:
        - name: media
          mountPath: /media
          subPath: media
        - name: custom-assets
          mountPath: /web/dist/custom.css
          subPath: custom.css
      volumes:
        - name: media
          persistentVolumeClaim:
            claimName: "${VOLSYNC_CLAIM:=${APP}}"
        - name: custom-assets
          configMap:
            name: authentik-custom-assets
      route:
        main:
          enabled: true
          hostnames:
            - "auth.${DOMAIN_ID}"
          parentRefs:
            - name: envoy-external
              namespace: network
              sectionName: https

    # Authentik Worker
    worker:
      replicas: 1
      resources:
        requests:
          cpu: 80m
          memory: 512Mi
        limits:
          memory: 1Gi

    # Prometheus
    prometheus:
      rules:
        enabled: true
        namespace: security

  postRenderers:
    # Allow pods to be evicted when unhealthy
    # This occurs during postgres failover, which is required for node draining
    - kustomize:
        patches:
          - patch: |
              - op: add
                path: /spec/unhealthyPodEvictionPolicy
                value: AlwaysAllow
            target:
              group: policy
              version: v1
              kind: PodDisruptionBudget
