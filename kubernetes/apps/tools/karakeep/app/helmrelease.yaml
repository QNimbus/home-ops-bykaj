---
# yaml-language-server: $schema=https://schemas.bykaj.io/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app karakeep
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    controllers:
      karakeep:
        forceRename: *app
        annotations:
          reloader.stakater.com/auto: "true"
        initContainers:
          init-migrate: &container
            image:
              repository: ghcr.io/karakeep-app/karakeep
              tag: latest@sha256:ccc70f0c9151692ace73cbcc5c4d7acaa3f03cab6faf215912a4d1bb8038f9b0
            workingDir: /db_migrations
            command:
              - node
              - index.js
            envFrom:
              - secretRef:
                  name: &secret karakeep-secret
            env:
              ASSET_STORE_S3_FORCE_PATH_STYLE: "true"
              BROWSER_WEBSOCKET_URL: ws://karakeep-browserless:3000/chromium?token=$(TOKEN)&blockAds=true&launch={"stealth":true}
              COREPACK_INTEGRITY_KEYS: "0"
              CRAWLER_DOWNLOAD_BANNER_IMAGE: "true"
              CRAWLER_ENABLE_ADBLOCKER: "true"
              CRAWLER_FULL_PAGE_ARCHIVE: "true"
              CRAWLER_FULL_PAGE_SCREENSHOT: "true"
              CRAWLER_STORE_SCREENSHOT: "true"
              DATA_DIR: "/data"
              DISABLE_NEW_RELEASE_CHECK: "true"
              DISABLE_PASSWORD_AUTH: "false"
              DISABLE_SIGNUPS: "false"
              INFERENCE_ENABLE_AUTO_SUMMARIZATION: "true"
              INFERENCE_ENABLE_AUTO_TAGGING: "true"
              INFERENCE_IMAGE_MODEL: "gpt-4o-mini"
              INFERENCE_LANG: "english"
              INFERENCE_TEXT_MODEL: "gpt-4.1-mini"
              MEILI_ADDR: "http://meilisearch.database:7700"
              NEXTAUTH_URL: "https://links.${DOMAIN_APP_APPS}"
              OAUTH_ALLOW_DANGEROUS_EMAIL_ACCOUNT_LINKING: "true"
              OAUTH_PROVIDER_NAME: "Cetana ID"
              OAUTH_SCOPE: "openid profile email"
              OCR_LANGS: "eng,nld"
              RATE_LIMITING_ENABLED: "true"
              TZ: "${TIMEZONE}"
            securityContext:
              readOnlyRootFilesystem: true
              allowPrivilegeEscalation: false
              capabilities: {drop: [ALL]}
        containers:
          web:
            <<: *container
            workingDir: /app/apps/web
            command:
              - node
              - server.js
            probes:
              startup:
                enabled: true
                spec:
                  failureThreshold: 30
                  periodSeconds: 5
              liveness:
                enabled: true
              readiness:
                enabled: true
            resources:
              requests:
                cpu: 10m
                memory: 256Mi
              limits:
                memory: 1Gi
          worker:
            <<: *container
            workingDir: /app/apps/workers
            command:
              - npm
              - run
              - start:prod
            resources:
              requests:
                cpu: 10m
                memory: 256Mi
              limits:
                memory: 1Gi

      browserless:
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          app:
            image:
              repository: ghcr.io/browserless/chromium
              tag: v2.33.0@sha256:a7ef061130e593b2a8e03c3b1c379ef0cbca95f857ae532831d66ba6a933cd72
              pullPolicy: IfNotPresent
            env:
              DEBUG: "browserless*,-*:trace,-*:verbose"
              CONCURRENT: "5"
              ENABLE_DEBUGGER: "false"
              TIMEOUT: "60000"
              TOKEN:
                valueFrom:
                  secretKeyRef:
                    name: *secret
                    key: TOKEN
              TZ: "${TIMEZONE}"
            probes:
              liveness:
                enabled: true
              readiness:
                enabled: true
            resources:
              requests:
                cpu: 10m
                memory: 512Mi
              limits:
                memory: 1Gi
            securityContext:
              runAsUser: 999
              runAsGroup: 999
              allowPrivilegeEscalation: false
              capabilities: {drop: [ALL]}

    persistence:
      config:
        existingClaim: karakeep-config
        advancedMounts:
          karakeep:
            init-migrate: &data
              - path: /data
            web: *data
            worker: *data
      tmpfs:
        type: emptyDir
        advancedMounts:
          karakeep:
            init-migrate: &cache
              - path: /app/apps/web/.next/cache
                subPath: cache
            web: *cache
            worker: *cache
        globalMounts:
          - path: /tmp
            subPath: tmp

    route:
      app:
        hostnames: ["links.${DOMAIN_APP_APPS}"]
        parentRefs:
          - name: external
            namespace: kube-system
            sectionName: https-app-apps
        rules:
          - backendRefs:
              - identifier: *app
                port: &port 3000

    service:
      karakeep:
        primary: true
        controller: *app
        ports:
          http:
            port: *port
      browserless:
        controller: browserless
        ports:
          http:
            port: 3000

