---
# yaml-language-server: $schema=https://schemas.bykaj.io/external-secrets.io/clusterexternalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ClusterExternalSecret
metadata:
  name: cluster-secrets
spec:
  refreshTime: 5m
  externalSecretName: cluster-secrets
  namespaceSelectors:
    - matchLabels:
        external-secrets.io/clustersecrets: "true"
  externalSecretSpec:
    refreshPolicy: OnChange
    secretStoreRef:
      kind: ClusterSecretStore
      name: onepassword
    target:
      name: cluster-secrets
      creationPolicy: Owner
      template:
        data:
          # Domains
          DOMAIN_APP: "{{ .CL_DOMAIN_APP }}"
          DOMAIN_DEV: "{{ .CL_DOMAIN_DEV }}"
          DOMAIN_ID: "{{ .CL_DOMAIN_ID }}"
          DOMAIN_IO: "{{ .CL_DOMAIN_IO }}"
          DOMAIN_LOL: "{{ .CL_DOMAIN_LOL }}"
          DOMAIN_NET: "{{ .CL_DOMAIN_NET }}"
          DOMAIN_ST: "{{ .CL_DOMAIN_ST }}"
          TAILSCALE_DOMAIN: "{{ .TS_DOMAIN }}"
          # Servers
          DB_HOST: "{{ .CL_DB_HOST }}"
          MQTT_HOST: "{{ .CL_MQTT_HOST }}"
          NAS_HOST: "{{ .CL_NAS_HOST }}"
          REDIS_HOST: "{{ .CL_REDIS_HOST }}"
    dataFrom:
      - extract:
          key: cluster
        rewrite: [{regexp: {source: (.*), target: CL_$1}}]
      - extract:
          key: tailscale
        rewrite: [{regexp: {source: (.*), target: TS_$1}}]
